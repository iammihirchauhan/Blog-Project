{% extends "base.html" %} 
{% block title %}Blogs{% endblock %} 
{% block content%}

<div class="text-end mb-3">
  <button id="add-blog-btn" class="btn btn-success px-4">New Blog</button>
</div>

{% for b in blogs %}
<div class="card blog-card mb-3 shadow-sm position-relative" data-id="{{ b.id }}">
  <div class="card-body">
    <h5>{{ b.title }}</h5>
    <small class="text-muted">by {{ b.user.username }}</small>
    <p class="mt-2">{{ b.content }}</p>

    {% if user == b.user %}
    <div class="d-flex gap-2 position-absolute top-0 end-0 p-2">
      <button
        type="button"
        class="btn btn-warning btn-sm edit-blog-btn"
        data-id="{{ b.id }}"
        data-title="{{ b.title }}" data-content="{{ b.content }}">
        Edit
      </button>

      <button type="button" class="btn btn-danger btn-sm delete-blog-btn" data-id="{{ b.id }}">
        Delete
      </button>
    </div>
    {% endif %}
  </div>
</div>
{% empty %}
<p class="text-muted text-center">No blogs yet.</p>
{% endfor %}

<div class="modal fade" id="manageBlogModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="blog-form">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title" id="modal-title">Create Blog</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="blog_id" />

          <div id="showError" class="alert alert-danger d-none"></div>

          <input type="text" id="blog_title" class="form-control mb-2" placeholder="Title" required/>
          <small id="titleError" class="text-danger d-none"></small>

          <textarea id="blog_content" class="form-control" rows="4" placeholder="Content" required></textarea>
          <small id="contentError" class="text-danger d-none"></small>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-success" id="modal-submit-btn">
            Publish
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    const blogModal = new bootstrap.Modal(
      document.getElementById("manageBlogModal")
    );

    function showGlobalError(msg) {
      $("#showError").text(msg).removeClass("d-none");
    }

    function clearGlobalError() {
      $("#showError").addClass("d-none").text("");
    }

    function showFieldError(field, msg) {
      if (field === "title") {
        $("#titleError").text(msg).removeClass("d-none");
      } else if (field === "content") {
        $("#contentError").text(msg).removeClass("d-none");
      }
    }

    function clearFieldErrors() {
      $("#titleError, #contentError").addClass("d-none").text("");
    }

    $("#add-blog-btn").on("click", function () {
      clearGlobalError();
      clearFieldErrors();
      $("#modal-title").text("Create Blog");
      $("#modal-submit-btn").text("Publish");
      $("#blog_id").val("");
      $("#blog_title").val("");
      $("#blog_content").val("");
      blogModal.show();
    });

    $(document).on("click", ".edit-blog-btn", function () {
      clearGlobalError();
      clearFieldErrors();
      $("#modal-title").text("Edit Blog");
      $("#modal-submit-btn").text("Update");
      $("#blog_id").val($(this).data("id"));
      $("#blog_title").val($(this).data("title"));
      $("#blog_content").val($(this).data("content"));
      blogModal.show();
    });

    $("#blog-form").on("submit", function (e) {
      e.preventDefault();
      clearGlobalError();
      clearFieldErrors();

      const blogId = $("#blog_id").val();
      const payload = {
        title: $("#blog_title").val(),
        content: $("#blog_content").val(),
      };

      if (!payload.title.trim()) {
        showFieldError("title", "Title is required");
        return;
      }

      if (!payload.content.trim()) {
        showFieldError("content", "Content cannot be empty");
        return;
      }

      const title = $("#blog_title").val().trim();
      const content = $("#blog_content").val().trim();

      const method = blogId ? "PUT" : "POST";
      const url = blogId ? `/blogs/${blogId}/` : `/blogs/`;

      ajaxRequest({
        url: url,
        method: method,
        data: payload,
        onSuccess: function () {
          blogModal.hide();

          if (blogId) {
            const card = $(`.blog-card[data-id="${blogId}"]`);
            card.find("h5").text(payload.title);
            card.find("p").text(payload.content);
            const editBtn = card.find(".edit-blog-btn");
            editBtn.data("title", payload.title);
            editBtn.data("content", payload.content);
          } else {
            location.reload();
          }
        },
      });
    });

    $(document).on("click", ".delete-blog-btn", function () {
      if (!confirm("Are you sure you want to delete this blog?")) return;

      const blogId = $(this).data("id");
      const card = $(this).closest(".card");

      ajaxRequest({
        url: `/blogs/${blogId}/`,
        method: "DELETE",
        onSuccess: function () {
          card.remove();
        },
        onError: function () {
          alert("Delete failed");
        },
      });
    });

    $("#blog_title").on("input", function () {
      $(this).val($(this).val().trimStart());
      $("#titleError").addClass("d-none").text("");
      clearGlobalError();
    });

    $("#blog_content").on("input", function () {
      $(this).val($(this).val().trimStart());
      $("#contentError").addClass("d-none").text("");
      clearGlobalError();
    });
  });
</script>
{% endblock %}
